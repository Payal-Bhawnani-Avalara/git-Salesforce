<apex:page controller="n2de.TeamActionTrackingDetailController" action="{!init}" tabStyle="n2de__Team__c" sidebar="false">

    <script type="text/javascript" src="{!URLFOR($Resource.DEResources, 'scripts/jquery-1.7.1.min.js')}"></script>
    <script type="text/javascript" src="{!URLFOR($Resource.DEResources, 'scripts/jquery-ui-1.10.4.min.js')}"></script>
    <script type="text/javascript" src="{!URLFOR($Resource.DEResources, 'scripts/jquery.multiselect.min.js')}"></script>
    <script type="text/javascript" src="{!URLFOR($Resource.DEResources, 'scripts/requiredBlockUtil.js')}"></script>
    <link rel="stylesheet" href="{!URLFOR($Resource.DEResources, 'css/jquery-ui-1.10.4-nc2.css')}" type="text/css"/>
    <link rel="stylesheet" href="{!URLFOR($Resource.DEResources, 'css/jquery.multiselect.css')}" type="text/css"/>

    <style>
    .tableHeader {
        font-size: 11px;
        color: #4A4A56;
        padding-bottom: 3px;
    }
    .alertCol {
        padding-right: 10px;
    }
    .alertSeq {
        width: 20px;
    }
    .alertOperator {
        width: 110px;
    }
    .addRowLink {
        padding-top: 4px;
        padding-bottom: 10px;
    }
    .label {
        font-weight: bold;
        color: #4A4A56;
    }
    .alertMsg {
        color: red;
        font-weight: bold;
        padding-left: 40px;
    }

    </style>

    <c:CommonHelp help_page="team-detail"/>
    <c:CommonMask />
    <apex:form id="tracking_form" styleClass="tracking_form">
        <apex:sectionHeader title="Team Action Tracking" subtitle="{!team.Name}" rendered="{!team.Name != null}"/>

        <apex:pageBlock title="Tracking Edit" id="page_block" mode="edit">
            <apex:actionFunction action="{!changeActionsTracked}" name="changeActionsTrackedAF" reRender="page_block"/>

            <script type="text/javascript">
            $(document).ready(function($){
                $('.tracking_form').on("keyup keypress", function(e) {
                      var code = e.keyCode || e.which;
                      if (code  == 13) {
                        e.preventDefault();
                        return false;
                    }
                });
                $('.multiselectAction').multiselect({
                    minWidth: 400,
                    noneSelectedText: 'Select actions to track',
                    selectedList: 2,
                    classes: 'team-multiselect',
                    multiple: true,
                    position: {
                         my: 'left top',
                        at: 'left bottom',
                        collision: 'flip'
                    },
                    close: function() {
                        showMask();
                        changeActionsTrackedAF();
                    }
                });
                $('.multiselectEvent').multiselect({
                    minWidth: 400,
                    noneSelectedText: '--All event types--',
                    selectedList: 4,
                    classes: 'team-multiselect',
                    position: {
                        my: 'left top',
                          at: 'left bottom',
                        collision: 'flip'
                    }
                });
                $('.multiselectTask').multiselect({
                    minWidth: 400,
                    noneSelectedText: '--All task types--',
                    selectedList: 4,
                    classes: 'team-multiselect',
                    position: {
                        my: 'left top',
                          at: 'left bottom',
                        collision: 'flip'
                    }
                });
                hideMask();
            });

            function resetActionMultiSelect() {
                $('.multiselectAction').multiselect({
                    minWidth: 400,
                    noneSelectedText: 'Select actions to track',
                    selectedList: 2,
                    classes: 'team-multiselect',
                    multiple: false,
                    position: {
                        my: 'left top',
                        at: 'left bottom',
                        collision: 'flip'
                    }
                });
            }

            </script>

            <apex:pageMessages escape="false"/>

            <apex:pageBlockButtons >
                <apex:commandButton action="{!saveTracking}" value="Save"/>
                <apex:commandButton action="{!cancelTracking}" value="Cancel" immediate="true"/>
            </apex:pageBlockButtons>

            <apex:pageBlockSection id="object_actions" title="Time to Action" columns="2" collapsible="false" rendered="{!AND(OR(Team.n2de__Object_name__c == 'Lead', Team.n2de__Object_name__c == 'Case'), NOT(Team.n2de__Is_distribute_to_queue__c))}">
                <apex:inputField value="{!Team.n2de__Is_action_tracking__c}">
                    <apex:actionSupport action="{!setDefaultActionTracking}" event="onchange" onsubmit="showMask();" reRender="page_block"/>
                </apex:inputField>
                <c:CommonInlineHelp help_page="action-tracking"/>
                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Actions_respect_distribution_hours__c}" rendered="{!Team.n2de__Is_action_tracking__c}">
                    <apex:outputLabel value="Respect distribution hours"/>
                    <apex:selectList value="{!Team.n2de__Actions_respect_distribution_hours__c}" size="1">
                        <apex:selectOptions value="{!RespectDistributionHoursOptionList}"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem rendered="{!Team.n2de__Is_action_tracking__c}"/>
                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Object_action_field_name__c.InlineHelpText}" rendered="{!Team.n2de__Is_action_tracking__c}">
                    <apex:outputLabel value="{!$ObjectType.n2de__Team__c.Fields.n2de__Object_action_field_name__c.Label}"/>
                    <apex:selectList value="{!Team.n2de__Object_action_field_name__c}" size="1">
                        <apex:selectOptions value="{!ObjectActionFieldOptionList}"/>
                        <apex:actionSupport event="onchange" action="{!changeActionTrackingObject}" onsubmit="showMask();" oncomplete="resetActionMultiSelect()" reRender="page_block"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Object_action_tracked_value__c.InlineHelpText}" rendered="{!Team.n2de__Is_action_tracking__c}">
                    <apex:outputLabel value="Actions to track"/>
                    <apex:selectList value="{!ActionsTracked}" size="5" multiSelect="true" styleClass="multiselectAction requiredIndicator">
                        <apex:selectOptions value="{!ObjectActionValueOptionList}"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>

            <apex:pageBlockSection id="auto_actions" title="Auto-action" collapsible="false" columns="2" rendered="{!AND(OR(Team.n2de__Object_name__c == 'Lead', Team.n2de__Object_name__c == 'Case'), NOT(Team.n2de__Is_distribute_to_queue__c), Team.n2de__Is_action_tracking__c)}">
                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Is_auto_action_on_event__c.InlineHelpText}">
                    <apex:outputLabel value="Auto-action on event"/>
                    <apex:inputField value="{!Team.n2de__Is_auto_action_on_event__c}">
                        <apex:actionSupport event="onchange" onsubmit="showMask();" reRender="page_block"/>
                    </apex:inputField>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem rendered="{!NOT(Team.n2de__Is_auto_action_on_event__c)}"/>

                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Event_types_to_action__c.InlineHelpText}" rendered="{!Team.n2de__Is_auto_action_on_event__c}">
                    <apex:outputLabel value="{!$ObjectType.n2de__Team__c.Fields.n2de__Event_types_to_action__c.Label}"/>
                    <apex:selectList value="{!EventTypesToTriggerAction}" size="1" multiSelect="true" styleClass="multiselectEvent">
                        <apex:selectOptions value="{!EventTypeOptionList}"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem helpText="Auto-action on task">
                    <apex:outputLabel value="{!$ObjectType.n2de__Team__c.Fields.n2de__Is_auto_action_on_task__c.Label}"/>
                    <apex:inputField value="{!Team.n2de__Is_auto_action_on_task__c}">
                        <apex:actionSupport event="onchange" onsubmit="showMask();" reRender="page_block"/>
                    </apex:inputField>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Task_types_to_action__c.InlineHelpText}" rendered="{!Team.n2de__Is_auto_action_on_task__c}">
                    <apex:outputLabel value="{!$ObjectType.n2de__Team__c.Fields.n2de__Task_types_to_action__c.Label}"/>
                    <apex:selectList value="{!TaskTypesToTriggerAction}" size="1" multiSelect="true" styleClass="multiselectTask">
                        <apex:selectOptions value="{!TaskTypeOptionList}"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem rendered="{!NOT(Team.n2de__Is_auto_action_on_task__c)}"/>

                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Auto_action_value__c.InlineHelpText}" rendered="{!OR(Team.n2de__Is_auto_action_on_event__c, Team.n2de__Is_auto_action_on_task__c)}">
                    <apex:outputLabel value="Action to set"/>
                    <apex:selectList value="{!Team.n2de__Auto_action_value__c}" size="1" multiselect="false">
                        <apex:selectOptions value="{!ActionsTrackedOptions}"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>


            <apex:pageBlockSection id="object_alerts" title="Alerts" columns="1" collapsible="false" rendered="{!NOT(Team.n2de__Is_distribute_to_queue__c)}">
                <c:CommonInlineHelp help_page="alerts"/>
                <apex:pageMessage severity="warning" summary="{!ReassignWarnMessage}" rendered="{!AlertHasRelatedReassigns}" strength="1"/>
                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Team__c.Fields.n2de__Is_alert__c.InlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.n2de__Team__c.Fields.n2de__Is_alert__c.Label}"/>
                    <apex:outputPanel >
                        <apex:inputField value="{!Team.n2de__Is_alert__c}">
                            <apex:actionSupport action="{!switchEnableAlerts}" event="onchange" onsubmit="showMask();" reRender="page_block"/>
                        </apex:inputField>
                        <apex:outputText value="Note: Distributors for this team have alerts enabled. On save, alerts & auto-reassign will be disabled for those distributors." rendered="{!HasAlertDistributorWarning}" styleClass="alertMsg"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:selectList value="{!Team.n2de__Alert_respect_distribution_hours__c}" size="1" rendered="{!Team.n2de__Is_alert__c}">
                    <apex:selectOptions value="{!RespectDistributionHoursOptionList}"/>
                </apex:selectList>
                <apex:pageBlockSectionItem />
                <apex:selectList value="{!Team.n2de__Alert_type__c}" size="1" rendered="{!AND(CustomAlertsEnabled, Team.n2de__Is_alert__c)}">
                    <apex:selectOptions value="{!AlertTypeOptionList}"/>
                    <apex:actionSupport event="onchange" action="{!switchAlertType}" onsubmit="showMask()" oncomplete="hideMask()" reRender="page_block"/>
                </apex:selectList>
            </apex:pageBlockSection>

            <apex:pageBlockSection id="object_alert_rows" columns="1" collapsible="false" rendered="{!NOT(Team.n2de__Is_distribute_to_queue__c)}">
                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Distribution_team_alert__c.Fields.n2de__Alert_sequence__c.InlineHelpText}" rendered="{!AND(Team.n2de__Is_alert__c, Team.n2de__Alert_type__c!='Custom Date/Time')}">
                    <apex:outputLabel value="Alerts"/>
                    <apex:outputPanel id="alert_panel">
                        <apex:dataTable value="{!TeamAlertList}" var="alert" headerClass="tableHeader">
                            <apex:column styleClass="alertSeq">
                                <apex:outputText value="{!alert.AlertSeq}" styleClass="label"/>
                            </apex:column>
                            <apex:column styleClass="alertCol">
                                <apex:facet name="header">{!$ObjectType.n2de__Distribution_team_alert__c.Fields.n2de__Alert_period__c.Label}</apex:facet>
                                <apex:inputText value="{!alert.AlertPeriodText}" maxlength="5" size="2"/>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_unit__c}" size="1">
                                    <apex:selectOptions value="{!alert.AlertUnitOptionList}"/>
                                </apex:selectList>
                            </apex:column>
                            <apex:column >
                                <apex:facet name="header">Condition Field</apex:facet>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_field_name__c}" size="1">
                                    <apex:selectOptions value="{!alert.AlertFieldOptionList}"/>
                                    <apex:actionSupport action="{!alert.changeAlertCondition}" onsubmit="showMask();" event="onchange" reRender="page_block"/>
                                </apex:selectList>
                            </apex:column>
                            <apex:column >
                                <apex:facet name="header">Operator</apex:facet>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_operator__c}" size="1" styleClass="alertOperator" disabled="{!alert.TeamAlert.n2de__Alert_condition_field_name__c=null}">
                                    <apex:selectOptions value="{!alert.AlertComparisonOperatorOptionList}"/>
                                </apex:selectList>
                            </apex:column>
                            <apex:column >
                                <apex:facet name="header">Value</apex:facet>
                                <apex:inputText value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" rendered="{!OR(alert.AlertFieldType=='', alert.AlertFieldType=='STRING', alert.AlertFieldType=='DOUBLE')}" disabled="{!alert.TeamAlert.n2de__Alert_condition_field_name__c=null}"/>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" size="1" rendered="{!alert.AlertFieldType=='BOOLEAN'}">
                                    <apex:selectOption itemValue="true" itemLabel="true"/>
                                    <apex:selectOption itemValue="false" itemLabel="false"/>
                                </apex:selectList>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" size="1" rendered="{!alert.AlertFieldType=='PICKLIST'}">
                                    <apex:selectOptions value="{!alert.AlertFieldPicklistOptionList}"/>
                                </apex:selectList>
                                <apex:outputText value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" rendered="{!OR(alert.AlertFieldType=='DATE', alert.AlertFieldType=='DATETIME')}"/>
                            </apex:column>
                        </apex:dataTable>
                        <div class="addRowLink">
                            <apex:commandLink action="{!addAlertRow}" onclick="showMask()" value="Add Row" reRender="page_block" rendered="{!TeamAlertList.size<MaxAlertRows}"/>&nbsp;&nbsp;<apex:commandLink action="{!removeAlertRow}" value="Remove Row" onclick="showMask()" reRender="page_block" rendered="{!TeamAlertList.size>1}"/>
                        </div>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem helpText="{!$ObjectType.n2de__Distribution_team_alert__c.Fields.n2de__Alert_sequence__c.InlineHelpText}" rendered="{!AND(Team.n2de__Is_alert__c, Team.n2de__Alert_type__c='Custom Date/Time', CustomAlertsEnabled)}">
                    <apex:outputLabel value="Alerts"/>
                    <apex:outputPanel id="dt_alert_panel">
                        <apex:dataTable value="{!TeamAlertList}" var="alert" headerClass="tableHeader">
                            <apex:column styleClass="alertSeq">
                                <apex:outputText value="{!alert.AlertSeq}" styleClass="label"/>
                            </apex:column>
                            <apex:column styleClass="alertCol">
                                <apex:facet name="header">{!$ObjectType.n2de__Distribution_team_alert__c.Fields.n2de__Alert_datetime_field__c.Label}</apex:facet>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_datetime_field__c}" size="1">
                                    <apex:selectOptions value="{!alert.DateTimeFieldOptionList}"/>
                                </apex:selectList>
                            </apex:column>
                            <apex:column >
                                <apex:facet name="header">Condition Field</apex:facet>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_field_name__c}" size="1">
                                    <apex:selectOptions value="{!alert.AlertFieldOptionList}"/>
                                    <apex:actionSupport action="{!alert.changeAlertCondition}" onsubmit="showMask();" event="onchange" reRender="page_block"/>
                                </apex:selectList>
                            </apex:column>
                            <apex:column >
                                <apex:facet name="header">Operator</apex:facet>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_operator__c}" size="1" styleClass="alertOperator" disabled="{!alert.TeamAlert.n2de__Alert_condition_field_name__c=null}">
                                    <apex:selectOptions value="{!alert.AlertComparisonOperatorOptionList}"/>
                                </apex:selectList>
                            </apex:column>
                            <apex:column >
                                <apex:facet name="header">Value</apex:facet>
                                <apex:inputText value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" rendered="{!OR(alert.AlertFieldType=='', alert.AlertFieldType=='STRING', alert.AlertFieldType=='DOUBLE')}" disabled="{!alert.TeamAlert.n2de__Alert_condition_field_name__c=null}"/>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" size="1" rendered="{!alert.AlertFieldType=='BOOLEAN'}">
                                    <apex:selectOption itemValue="true" itemLabel="true"/>
                                    <apex:selectOption itemValue="false" itemLabel="false"/>
                                </apex:selectList>
                                <apex:selectList value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" size="1" rendered="{!alert.AlertFieldType=='PICKLIST'}">
                                    <apex:selectOptions value="{!alert.AlertFieldPicklistOptionList}"/>
                                </apex:selectList>
                                <apex:outputText value="{!alert.TeamAlert.n2de__Alert_condition_argument__c}" rendered="{!OR(alert.AlertFieldType=='DATE', alert.AlertFieldType=='DATETIME')}"/>
                            </apex:column>
                        </apex:dataTable>
                        <div class="addRowLink">
                            <apex:commandLink action="{!addAlertRow}" onclick="showMask()" value="Add Row" reRender="page_block" rendered="{!TeamAlertList.size<MaxAlertRows}"/>&nbsp;&nbsp;<apex:commandLink action="{!removeAlertRow}" value="Remove Row" onclick="showMask()" reRender="dt_alert_panel,script_panel" rendered="{!TeamAlertList.size>1}"/>
                        </div>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

            </apex:pageBlockSection>
        </apex:pageBlock>
    </apex:form>
    <c:StatusPanel />
</apex:page>