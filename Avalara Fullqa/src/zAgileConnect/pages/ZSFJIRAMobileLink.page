<apex:page docType="html-5.0" showHeader="false" sidebar="false" standardcontroller="Case"
           extensions="zsfjira.ZSFJIRAMobileLinkController">
    <apex:stylesheet value="{!URLFOR($Resource.zsfjira__bootstrap, 'bootstrap-3.2.0-dist/css/bootstrap.min.css')}" />
    <apex:includeScript value="{!URLFOR($Resource.zsfjira__jQuery, '/js/jquery-1.9.1.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.zsfjira__bootstrap, 'bootstrap-3.2.0-dist/js/bootstrap.min.js')}"/>    
    <style>
        .loading_modal{
        display: none;
        background: url({!$Resource.loader})
        no-repeat center;
        width: 100%;height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 1002;
        }
        body {
        padding-top: 70px;
        padding-bottom: 70px;
        }
        .intro{
        margin-top:20px;
        }
        #toggleMenu:hover{
        background-color: #285e8e;
        }
        #toggleMenu{
        background-color: #3071a9;
        }
    </style>
    <style>
        .black_overlay{
        display: none;
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: black;
        z-index:1001;
        -moz-opacity: 0.8;
        opacity:.80;
        filter: alpha(opacity=80);
        }
    </style>
    
    <script>
    (
        function(){
            try{
                var a=navigator.userAgent+'';
                a = a.toUpperCase();                
                if(a.indexOf('IPHONE')!=-1||a.indexOf('IPAD')!=-1){                    
                    var s=document.createElement('style');
                    s.innerHTML="html,html body{overflow: auto;-webkit-overflow-scrolling:touch;}body{position:absolute;left:0;right:0;top:0;bottom:0;}";
                    document.getElementsByTagName('head')[0].appendChild(s);
                }
            }catch(e){
                
            }
        }
    )();
    </script>
    <body>
        <div style="position: absolute;border-color: #285e8e;background-color: #3071a9;" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header" >
                    <apex:outputPanel rendered="{!NOT(hasReadOnlyAccessCurrentUser)}">
                        <button type="button" id="toggleMenu"
                                style="border-color: white;" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>                        
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                    </apex:outputPanel>
                    <a style="color: white;" class="navbar-brand" onclick="mainVF();">Related JIRA Issues</a>
                </div>
                <div id="headNav" class="collapse navbar-collapse" style="border-color: white;overflow: auto;">
                    <apex:outputPanel rendered="{!NOT(hasReadOnlyAccessCurrentUser)}">
                        <ul id="menuOptions" class="nav navbar-nav">
                            <li><a style="color: white;" onclick="newVF();">New</a></li>
                            <!--<li><a style="color: white;" onclick="searchVF();">Find Issues</a></li>-->
                            <li><a style="color: white;" onclick="caseCommVF();">Case Comments</a></li>
                        </ul>
                    </apex:outputPanel>
                </div><!--/.nav-collapse -->
            </div>
        </div>
        <div id='iframePanel'>
            <div id='iframe'>
                <iframe id="frameJIRA"
                        src='' scrolling = 'no' width="100%" frameBorder="0" onLoad="if(this.src!=''){finishLoading();}"/>                
            </div>            
            <div class = "loading_modal" id='loadingFrame'/>
        </div>
        <!--<nav style="border-color: #285e8e;background-color: #3071a9;bottom:0;"
             class="navbar navbar-fixed-bottom navbar-inverse" id="footer">
            <div class="container">
                <div class="rightBar">
                    <center>
                        <div style="margin:20px;font-size:130%;color: white;" class="text-muted">
                        <span class="glyphicon glyphicon-bullhorn " style=""></span>
                        zAgile Inc.</div>
                    </center>
                </div>
            </div>
        </nav>-->
        <div id="modalMessages" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <span class="glyphicon glyphicon-exclamation-sign"></span>
                        <h4 class="modal-title" id="titleModal"/>
                    </div>
                    <div class="modal-body">
                        <p class="text-warning" id='textModal'/>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
	<div id ='fade' class='black_overlay'/>    
    <script>
    $j = jQuery.noConflict();
    $j(function() {
        mainVF();
    });
    function getParameter(parm){
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0]==parm){
                return pair[1];
            }
        }
        return '';
    }
    function mainVF(){
        //var prefix = 'zsfjira';
        var caseId = '{!Case.Id}';
        var source = getParameter('page');
        if(source == ''){
            source = 'ZMCaseRelatedJiraIssues';
            //source = '/apex/' + prefix + '__' + source + '?id=' + caseId;
            source = '/apex/' + source + '?id=' + caseId;
        }
        else if(source == 'ZCreateOrEditIssueM'){
            var issueKey = getParameter('issueKey');
            if(issueKey==''){
                source = '/apex/' + source + '?id=' + caseId;
            }else{
                source = '/apex/' + source + '?issueKey=' + issueKey;
            }
        }else if(source == 'ZIssueDetailsM'){
            var issueKey = getParameter('issueKey');
            source = '/apex/' + source + '?issueKey=' + issueKey;
        }else{
            source = '/apex/' + source + '?id=' + caseId;
        }
        //document.body.style.overflow = 'hidden';
        var iframe = document.getElementById('frameJIRA');
        iframe.contentWindow.postMessage('REMOVE_CONTENT', "*");
        iframe.style.height = 100 + "px";
        loading();
        iframe.src = source;
    }
    //UNUSED FUNCTION
    function newVF(){
        $j("#headNav").attr("class","navbar-collapse collapse");
        var caseId = '{!Case.Id}';
        var vf = 'ZCreateOrEditIssueM';
        //var prefix = 'zsfjira';
        //var source = '/apex/' + prefix + '__' + vf + '?id=' + caseId;
        var source = '/apex/' + vf + '?id=' + caseId;
        var iframe = document.getElementById('frameJIRA');
        iframe.contentWindow.postMessage('REMOVE_CONTENT', "*");
        iframe.style.height = 100 + "px";
        loading();
        iframe.src = source;
    }
    //UNUSED FUNCTION
    function linkVF(){
        var caseId = '{!Case.Id}';
        var vf = 'ZLinkToIssueM'
        //var prefix = 'zsfjira';
        //var source = '/apex/' + prefix + '__' + vf + '?id=' + caseId;
        var source = '/apex/' + vf + '?id=' + caseId;
        var iframe = document.getElementById('frameJIRA');
        iframe.contentWindow.postMessage('REMOVE_CONTENT', "*");
        iframe.style.height = 100 + "px";
        loading();
        iframe.src = source;
    }
    //UNUSED FUNCTION
    function searchVF(){
        $j("#headNav").attr("class","navbar-collapse collapse");
        var caseId = '{!Case.Id}';
        var vf = 'ZIssueSearchResultM'
        //var prefix = 'zsfjira';
        //var source = '/apex/' + prefix + '__' + vf + '?id=' + caseId;
        var source = '/apex/' + vf + '?id=' + caseId;
        var iframe = document.getElementById('frameJIRA');
        iframe.contentWindow.postMessage('REMOVE_CONTENT', "*");
        loading();
        iframe.src = source;
    }
    function caseCommVF(){
        $j("#headNav").attr("class","navbar-collapse collapse");
        var caseId = '{!Case.Id}';
        var vf = 'ZCaseCommentM'
        //var prefix = 'zsfjira';
        //var source = '/apex/' + prefix + '__' + vf + '?id=' + caseId;
        var source = '/apex/' + vf + '?id=' + caseId;
        var iframe = document.getElementById('frameJIRA');
        iframe.contentWindow.postMessage('REMOVE_CONTENT', "*");
        loading();
        iframe.src = source;
    }
    function loading(){
        $j('#loadingFrame').css('display','block');
    }
    function finishLoading(){
        $j('#loadingFrame').css('display','none');
    }
    function loadModal(title,message){
        finishLoading();
        $j("#titleModal").text(title);
        $j("#textModal").html(message);
        $j("#modalMessages").modal('show');
    }
    function postListener(e){
        if(e.data.indexOf("IFRAME_SIZE_") == 0){
            var nheight = parseInt(e.data.substr(12));
            var newHeight = nheight;
            document.getElementById("frameJIRA").style.height = newHeight + "px";
        }
        if(e.data.indexOf("LOADING") == 0){
            loading();
        }
        if(e.data.indexOf("FADE") == 0){
            $j('#fade').css('display','block');
        }
        if(e.data.indexOf("NOFADE") == 0){
            $j('#fade').css('display','none');
        }                
        if(e.data.indexOf("FINISH") == 0){
            finishLoading();
        }
        if(e.data.indexOf("MODAL_") == 0){
            var title = e.data.substr(6);
            var index = title.search("_");
            var message = title.substr(index+1);
            title = title.substr(0,index);
            loadModal(title,message);
        }
        if(e.data.indexOf("ADD_DETAILS_") == 0){
            params = e.data.substr(12);
            var vf = 'ZCreateOrEditIssueM'
            //var prefix = 'zsfjira';
            var source = '/apex/' + vf + params;
            var iframe = document.getElementById('frameJIRA');
            iframe.contentWindow.postMessage('REMOVE_CONTENT', "*");
            loading();
            iframe.src = source;
        }
        if(e.data.indexOf("ENTITY_") == 0){
            var eid = e.data.substr(7);
            sforce.one.navigateToSObject(eid);
        }
    }
    window.addEventListener("message", postListener, false);
    </script>
</apex:page>