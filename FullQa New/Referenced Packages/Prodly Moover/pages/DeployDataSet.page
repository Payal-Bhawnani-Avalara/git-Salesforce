<apex:page showheader="{! IF( NOT ISNULL( $CurrentPage.parameters.showheadersidebar ), $CurrentPage.parameters.showheadersidebar, 'true' ) }" 
    sidebar="{! IF( NOT ISNULL( $CurrentPage.parameters.showsidebar ), $CurrentPage.parameters.showsidebar, 'true' ) }" 
    standardController="PDRI__DataSet__c" 
    extensions="PDRI.DeploymentController" 
    title="Deploy Data Set" 
    standardStylesheets="false">
    
    <script src="/soap/ajax/40.0/connection.js"></script>
    <script src="/soap/ajax/40.0/apex.js" type="text/javascript"></script>
    
    <apex:stylesheet value="{!URLFOR($Resource.PDRI__SLDS080, 'SLDS080/assets/styles/salesforce-lightning-design-system-vf.css')}"/>
    <!--MD-1499-->
    <apex:includeScript value="{!URLFOR($Resource.PDRI__MooverResources, 'scripts/general.js')}"/>
    <style>
        .slds-select1 {
            height : 98px !important;
        }
        /*MD-1499*/
        .dsLabel {
            font-size: 14px !important;
        }
        .tooltipIcon {
            display: inline-block !important;
            left: -11px;
        }
        /*MD-2713*/
		.tabblock{
			position: fixed;
		    z-index: 999999999;
		    width: 100%;
		    top: 0;
		    left: 0;
		    background: rgba(0, 0, 0, 0.29);
		    height: 100%;
		}
    </style>
    <script type="text/javascript">
        
        function cancelDeployDataSet() {
            window.location.href = 'apex/DataSetEditor?id={!rootDataSet.Id}';
        }
        
        function hideElemVisibility(elemId) {
            var elem = document.getElementById(elemId);
            if( !elem ) {
                return;
            }
            
            var elemClass = elem.getAttribute("class");
            
            if( elemClass.indexOf("slds-show") != -1 ) {
                elemClass = elemClass.replace("slds-show", "slds-hide");
                elem.setAttribute("class", elemClass);
            }
        }
         
        function showElemVisibility(elemId) {
            var elem = document.getElementById(elemId);
            var elemClass = elem.getAttribute("class");
            
            if( elemClass.indexOf("slds-hide") != -1 ) {
                elemClass = elemClass.replace("slds-hide", "slds-show");
                elem.setAttribute("class", elemClass);
            }
        }
        /*MD-1499 Start*/
        function tooltipDisplay(tooltipId) {
            toggleElemVisibility(tooltipId);
               
            }
            
            function toolTipDisplayOut(tooltipId) {
            toggleElemVisibility(tooltipId);
            
                                                                             
            }
            /*MD-1499 End*/
            //MD-2713 - START
			function showConfirmBox(elem){
				if(elem == 'true')
					showElemVisibility("WarningPrompt");
				else
					deployDataSet();
			}
			
			function isEventControlExists(){
				var warnCheckbox = document.getElementById("doNotWarnAgain");
				warnCheckbox.checked = false;
				isWarnForEventControlConfiguration();
			}
			
			function clickOkWarningPrompt(){
				var warnCheckbox = document.getElementById("doNotWarnAgain");
				if(warnCheckbox.checked){
					insertDeploymentCenterUIState();
				}
				else{
					deployDataSet();
				}
			}
            //MD-2713 - END
    </script>
    
    <apex:form id="theForm">    
        
        <!--  This script is to check how many orgs have been selected for deployment and accordingly it opens the deployment screen in the same/new window -->
        <a href="" id="ancherId" target="_blank"></a>
        <script type="text/javascript">
            var deploymentRe1sultIds =  '{!deploymentResults}';
            
            if(deploymentRe1sultIds != null && deploymentRe1sultIds != '') {
                var idArray = deploymentRe1sultIds.split(',');
                console.log('array ' + idArray);
                for(var i=0; i< idArray.length; i++) {
                    console.log('/' + idArray[i]);
                    if(i == 0) {
                        //MD-1680
                        document.getElementById("ancherId").setAttribute('target', '_parent');
                    }
                    else {
                        document.getElementById("ancherId").setAttribute('target', '_blank');  
                    }
                    //MD-1404 Added toast parameter
                    document.getElementById("ancherId").href = '/' + idArray[i]; //MD-1561 +'?isToastVisible=true';
                    document.getElementById("ancherId").click();
                }
            }
            
        </script>
        
        <apex:actionFunction action="{!doDeploy}" name="deployDataSet" rerender="theForm"/>
        <apex:actionFunction action="{!onDismissAlert}" name="dismissAlert" rerender="theForm"/>
        
        <!-- MD-2713  -->
        <apex:actionFunction action="{!isWarnForEventControlConfiguration}" name="isWarnForEventControlConfiguration" rerender="" oncomplete="showConfirmBox('{!showEventConfirmationBox}');" />
        <apex:actionFunction action="{!insertDeploymentCenterUIState}" name="insertDeploymentCenterUIState" rerender="" oncomplete="deployDataSet();" />
        
       <apex:outputPanel id="fullPanel" layout="block">
       <div class="slds">
            <div id="progressSpinner" class="slds-hide">
                <div class="slds-grid slds-grid--align-center slds-m-vertical--xx-large">
                    <div class="slds-spinner--large slds-m-vertical--xx-large">
                        <img class="slds-m-vertical--xx-large" src="{!URLFOR($Resource.SLDS080, 'SLDS080/assets/images/spinners/slds_spinner_brand.gif')}" alt="Loading..." />
                    </div>
                </div>
            </div>
            <apex:outputPanel id="alertPanel" layout="block" rendered="{!isAlertShown}">
            
                <div class="slds-grid slds-m-top--large slds-show" id="alertPanelDiv">
                    <div class="slds-notify slds-notify--alert slds-theme--error slds-theme--inverse-text slds-theme--alert-texture slds-size--1-of-1" role="alert">
                        <span class="slds-assistive-text">Info</span>
                        <button onclick="dismissAlert(); return false;" class="slds-button slds-button--icon-inverse slds-notify__close">
                            <img src="{!URLFOR($Resource.SLDS080, 'SLDS080/assets/icons/action/close_60.png')}" alt="Close" class="slds-button__icon" />
                            <span class="slds-assistive-text">Close</span>
                        </button>
                        <h2>{!alertMessage}</h2>
                    </div>
                </div>
            </apex:outputPanel>
            <!-- MD-2713 START-->
	        <div id="WarningPrompt" class="tabblock slds-hide" style="height: 640px;">
				<section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
					<div class="slds-modal__container"  style="bottom:20%;">
						<header class="slds-modal__header slds-text-heading--medium">
							<h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">{!$Label.LABEL_EVENT_CONTROL_CONFIRMATION_PROMPT_HEADING}</h2>
						</header>
	                             <div class="slds-modal__content slds-p-around_medium">  
	                                 <p style="white-space: pre-line;">{!$Label.LABEL_EVENT_CONTROL_CONFIRMATION_PROMPT_MESSAGE}</p>
	                                 <div class="slds-form-element" style="margin-bottom:20px; top:16px;">
	                                     <div class="slds-form-element__control" >
	                                         <label class="slds-checkbox">
	                                             <input type="checkbox" name="options" id="doNotWarnAgain"  class="CheckBoxClass" />
	                                             <span class="slds-checkbox--faux"></span>
	                                             <span class="slds-form-element__label slds-assistive-text"></span> 
	                                         </label>
	                                         <div class="slds-checkbox" >
	                                             <label class="slds-checkbox__label" for="checkbox-2" >
	                                                 <span class="slds-checkbox_faux"></span>
	                                                 <span class="slds-form-element__label">{!$Label.LABEL_DO_NOT_WARN_AGAIN}</span>
	                                             </label>
	                                         </div> 
	                                         
	                                     </div>
	                                 </div>
	                             </div>
						<footer class="slds-modal__footer">
							<button class="slds-button slds-button_neutral slds-button--neutral" onclick="hideElemVisibility('WarningPrompt'); return false;">Cancel</button>
							<button class="slds-button slds-button_brand slds-button--brand" onclick="clickOkWarningPrompt(); hideElemVisibility('WarningPrompt'); return false;">Yes</button> 
						</footer>
					</div>
				</section>
			</div>
	        <!-- MD-2713 - END -->
	        
            <apex:outputPanel id="settingsPanel">
                <div id="settingsPanelAll" class="slds-show">
                    <div class="slds-grid">
                        <div class="slds-col slds-size--4-of-6">      
                            <div role="form" class="slds-form--stacked slds-grid slds-wrap">
                                <div class="slds-form-element slds-m-top--large slds-size--3-of-6">
                                    <label class="slds-form-element__label dsLabel" for="selectSample1"><!--MD-1499 comment<div class="slds-text-heading--small">-->Source Salesforce Organization<!--</div>--></label>
                                    <!-- MD-1499 START -->
                                      <div class="slds-form-element tooltipIcon"  onmouseover="tooltipDisplay('tooltipSource');" onmouseout="toolTipDisplayOut('tooltipSource');">
                                        <div class="slds-form-element__icon slds-align-middle" >
                                            <img class="slds-button__icon" src="{!URLFOR($Resource.SLDS_Resource, 'assets/icons/utility/info_60.png')}" alt="Table" />
                                        </div>
                                      
                                        <div class="slds-popover slds-popover--tooltip slds-nubbin--left-top toggle slds-hide" role="tooltip" style="position: absolute;top: -26px;left: 28px;float: left;min-width: 312px;" id="tooltipSource">
                                           <div class="slds-popover__body">{!$Label.TOOL_TIP_SOURCE_SALESFORCE_ORGANIZATION}</div>
                                        </div>
                                        </div> 
                                    <!-- MD-1499 END -->
                                    <div class="slds-form-element__control slds-m-top--small">
                                        <apex:selectList id="sourceList" value="{!selectedSourceConnectionId}" size="1" required="false" styleClass="slds-select" onchange="queryCount({!rootDataSet.ObjectName__c}, {! JSENCODE(rootDataSet.Query_Filter__c) })"> 
                                            <apex:selectOptions value="{!connectionOptions}"/>
                                            <apex:actionSupport event="onchange" action="{!onSourceSelect}" reRender="alertPanel"/>
                                        </apex:selectList>
                                    </div>
                                </div>
                            </div>          
                            <div role="form" class="slds-form--stacked slds-grid slds-wrap">
                                <div class="slds-form-element slds-m-top--large slds-size--3-of-6">
                                    <label class="slds-form-element__label dsLabel" for="selectSample1"><!--MD-1499 comment<div class="slds-text-heading--small">-->Destination Salesforce Organization<!--</div>--></label>
                                    <!-- MD-1499 START -->
                                      <div class="slds-form-element tooltipIcon"  onmouseover="tooltipDisplay('tooltipDestination');" onmouseout="toolTipDisplayOut('tooltipDestination');">
                                        <div class="slds-form-element__icon slds-align-middle" >
                                            <img class="slds-button__icon" src="{!URLFOR($Resource.SLDS_Resource, 'assets/icons/utility/info_60.png')}" alt="Table" />
                                        </div>
                                      
                                        <div class="slds-popover slds-popover--tooltip slds-nubbin--left-top toggle slds-hide" role="tooltip" style="position: absolute;top: -49px;left: 30px;float: left;min-width: 312px;" id="tooltipDestination">
                                           <div class="slds-popover__body">{!$Label.TOOL_TIP_DESTINATION_SALESFORCE_ORGANIZATION}</div>
                                        </div> 
                                        </div>
                                    <!-- MD-1499 END -->
                                    <div class="slds-form-element__control slds-m-top--small">
                                        <apex:selectList id="targetList" value="{!selectedTargetConnectionIds}" size="3" required="false" styleClass="slds-select slds-select1" multiselect="true"> 
                                            <!-- MD-2886 change selectoptions value -->
                                            <apex:selectOptions value="{!destinationConnectionOptions}" />
                                        </apex:selectList>
                                    </div>
                                </div>   
                            </div>
                        </div>
                        <div class="slds-col"> 
                            <div class="slds-button-group slds-m-top--large">
                                <!-- MD-2197 Start -->
                                <button id="deployButton" onclick="isEventControlExists(); return false;" class="slds-button slds-button--neutral">Deploy</button>
                                <script>
                                     setDeployButtonDisable();
                                     
                                     function setDeployButtonDisable() {
                                         if( {!isNoConnectionError} ) {
                                             document.getElementById('deployButton').disabled = true;
                                         } else {
                                             document.getElementById('deployButton').disabled = false;
                                         }
                                     }
                                 </script>
                                 <!-- MD-2197 End -->
                                <button onclick="cancelDeployDataSet(); return false;" class="slds-button slds-button--neutral">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="slds-grid slds-m-top--x-large">
                        <div role="form" class="slds-form--stacked slds-grid slds-wrap">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label dsLabel" for="selectSample1"><!--MD-1499 comment<div class="slds-text-heading--small">-->Deployment Selection<!--</div>--></label>
                                <!-- MD-1499 START -->
                                  <div class="slds-form-element tooltipIcon"  onmouseover="tooltipDisplay('tooltipSelection');" onmouseout="toolTipDisplayOut('tooltipSelection');">
                                    <div class="slds-form-element__icon slds-align-middle" >
                                        <img class="slds-button__icon" src="{!URLFOR($Resource.SLDS_Resource, 'assets/icons/utility/info_60.png')}" alt="Table" />
                                    </div>
                                  
                                    <div class="slds-popover slds-popover--tooltip slds-nubbin--left-top toggle slds-hide" role="tooltip" style="position: absolute;top: -21px;left: 26px;float: left;di;min-width: 210px;" id="tooltipSelection">
                                       <div class="slds-popover__body">{!$Label.TOOL_TIP_DEPLOYDATASET_SELECTION}</div>
                                    </div> 
                                    </div>
                                <!-- MD-1499 END -->
                                <div class="slds-form-element__control" style="width: 700px;">
                                    <table class="slds-table slds-table--bordered slds-m-top--medium">
                                        <thead>
                                            <tr class="slds-text-heading--label">
                                                <th scope="col">
                                                    <span class="slds-truncate">Data Set Name</span>
                                                </th>
                                                <th scope="col">
                                                    <!--MD-1499-->
                                                    <span class="slds-truncate">Deployment Object</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="slds-hint-parent">
                                                <td>
                                                    <span class="slds-truncate"><a href="javascript:window.open('/{!rootDataSet.Id}','{!rootDataSet.Id}');" class="slds-truncate">{!rootDataSet.Name}</a></span><!-- MD-2486 -->
                                                </td>
                                                <td>
                                                    <span class="slds-truncate">{!rootObjectLabel}</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:outputPanel>
        </div>
        </apex:outputPanel>
    </apex:form>
</apex:page>